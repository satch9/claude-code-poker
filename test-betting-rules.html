<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Règles de Mise - Correction Bug Check après Raise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .poker-green { background: linear-gradient(135deg, #059669, #047857); }
        
        /* Action validation */
        .action-valid { border-color: #10b981; background-color: rgba(16, 185, 129, 0.1); }
        .action-invalid { border-color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
        .action-disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="min-h-screen poker-green text-white">
    <div class="max-w-6xl mx-auto p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold">Test Règles de Mise - Correction Bug</h1>
                <p class="text-green-200">Validation: Pas de CHECK après un RAISE</p>
            </div>
            <div class="flex gap-3">
                <button onclick="resetRound()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors">
                    Nouveau Tour
                </button>
                <button onclick="testScenario()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium transition-colors">
                    Test Scénario Bug
                </button>
            </div>
        </div>

        <!-- Game state display -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-900/90 backdrop-blur-sm rounded-xl p-4 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4">État du Tour de Mise</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span>Mise actuelle:</span>
                        <span id="currentBet" class="font-bold text-green-400">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Dernier raise par:</span>
                        <span id="lastRaiser" class="font-bold text-yellow-400">Aucun</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Tour de:</span>
                        <span id="currentTurn" class="font-bold text-blue-400">Joueur 1</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Phase:</span>
                        <span id="gamePhase" class="font-bold text-purple-400">Pré-flop</span>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900/90 backdrop-blur-sm rounded-xl p-4 border border-gray-700">
                <h3 class="text-lg font-semibold mb-4">Actions Récentes</h3>
                <div id="actionLog" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Actions will appear here -->
                </div>
            </div>
        </div>

        <!-- Player actions interface -->
        <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Actions Disponibles pour <span id="activePlayer">Joueur 1</span></h3>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- Player chips info -->
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span>Jetons du joueur:</span>
                        <span id="playerChips" class="font-bold">1000</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Mise actuelle du joueur:</span>
                        <span id="playerCurrentBet" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>À payer pour suivre:</span>
                        <span id="callAmount" class="font-bold text-orange-400">0</span>
                    </div>
                </div>

                <!-- Validation rules -->
                <div class="bg-gray-900/50 rounded-lg p-3">
                    <h4 class="text-sm font-semibold mb-2">Règles de Validation:</h4>
                    <ul class="text-xs space-y-1 text-gray-300">
                        <li id="rule1">✓ Fold: toujours possible</li>
                        <li id="rule2">✓ Check: si aucune mise à suivre</li>
                        <li id="rule3">✓ Call: si mise à suivre</li>
                        <li id="rule4">✓ Raise: si assez de jetons</li>
                    </ul>
                </div>
            </div>

            <!-- Action buttons -->
            <div class="space-y-4">
                <div class="grid grid-cols-4 gap-3">
                    <button onclick="performAction('fold')" 
                            class="action-btn px-4 py-3 bg-red-600 hover:bg-red-700 rounded-lg font-medium transition-colors" 
                            data-action="fold">
                        Fold
                    </button>
                    
                    <button onclick="performAction('check')" 
                            class="action-btn px-4 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-medium transition-colors" 
                            data-action="check" id="checkBtn">
                        Check
                    </button>
                    
                    <button onclick="performAction('call')" 
                            class="action-btn px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition-colors" 
                            data-action="call" id="callBtn">
                        Call <span id="callBtnAmount">0</span>
                    </button>
                    
                    <button onclick="showRaiseInput()" 
                            class="action-btn px-4 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-colors" 
                            data-action="raise" id="raiseBtn">
                        Raise
                    </button>
                </div>

                <!-- Raise input -->
                <div id="raiseInput" class="hidden bg-gray-900/50 rounded-lg p-4">
                    <div class="flex items-center gap-3">
                        <label class="text-sm font-medium">Montant:</label>
                        <input type="number" id="raiseAmount" min="0" value="200" 
                               class="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white">
                        <button onclick="performRaise()" 
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded font-medium">
                            Confirmer Raise
                        </button>
                        <button onclick="hideRaiseInput()" 
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded font-medium">
                            Annuler
                        </button>
                    </div>
                </div>
            </div>

            <!-- Validation messages -->
            <div id="validationMsg" class="mt-4 p-3 rounded-lg hidden">
                <!-- Validation messages will appear here -->
            </div>
        </div>

        <!-- Test scenarios -->
        <div class="mt-8 bg-gray-800 rounded-2xl p-6 border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Scénarios de Test</h3>
            <div class="grid grid-cols-3 gap-4">
                <button onclick="testScenario1()" class="px-4 py-3 bg-purple-600 hover:bg-purple-700 rounded-lg font-medium">
                    Scénario 1: Raise puis Check (Bug)
                </button>
                <button onclick="testScenario2()" class="px-4 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-medium">
                    Scénario 2: Check puis Raise
                </button>
                <button onclick="testScenario3()" class="px-4 py-3 bg-pink-600 hover:bg-pink-700 rounded-lg font-medium">
                    Scénario 3: Raise puis Call
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        let gameState = {
            currentBet: 0,
            lastRaiser: null,
            currentPlayer: 1,
            players: [
                { id: 1, name: 'Joueur 1', chips: 1000, currentBet: 0 },
                { id: 2, name: 'Joueur 2', chips: 1000, currentBet: 0 },
                { id: 3, name: 'Joueur 3', chips: 1000, currentBet: 0 },
                { id: 4, name: 'Joueur 4', chips: 1000, currentBet: 0 }
            ]
        };

        function updateDisplay() {
            const currentPlayerData = gameState.players[gameState.currentPlayer - 1];
            const callAmount = gameState.currentBet - currentPlayerData.currentBet;

            document.getElementById('currentBet').textContent = gameState.currentBet;
            document.getElementById('lastRaiser').textContent = gameState.lastRaiser || 'Aucun';
            document.getElementById('currentTurn').textContent = currentPlayerData.name;
            document.getElementById('activePlayer').textContent = currentPlayerData.name;
            document.getElementById('playerChips').textContent = currentPlayerData.chips;
            document.getElementById('playerCurrentBet').textContent = currentPlayerData.currentBet;
            document.getElementById('callAmount').textContent = callAmount;
            document.getElementById('callBtnAmount').textContent = callAmount;

            updateActionButtons(callAmount);
            updateValidationRules(callAmount);
        }

        function updateActionButtons(callAmount) {
            const checkBtn = document.getElementById('checkBtn');
            const callBtn = document.getElementById('callBtn');
            const raiseBtn = document.getElementById('raiseBtn');

            // Reset button states
            [checkBtn, callBtn, raiseBtn].forEach(btn => {
                btn.classList.remove('action-disabled', 'action-invalid');
            });

            // Check button validation
            if (callAmount > 0) {
                checkBtn.classList.add('action-disabled', 'action-invalid');
                checkBtn.title = 'Impossible de checker après un raise/bet';
            } else {
                checkBtn.classList.add('action-valid');
                checkBtn.title = 'Check possible';
            }

            // Call button validation
            if (callAmount === 0) {
                callBtn.classList.add('action-disabled');
                callBtn.title = 'Rien à suivre';
            } else {
                callBtn.classList.add('action-valid');
                callBtn.title = `Suivre ${callAmount}`;
            }
        }

        function updateValidationRules(callAmount) {
            document.getElementById('rule1').textContent = '✓ Fold: toujours possible';
            document.getElementById('rule2').textContent = callAmount > 0 ? 
                '✗ Check: impossible (mise à suivre)' : '✓ Check: possible (aucune mise)';
            document.getElementById('rule3').textContent = callAmount > 0 ? 
                `✓ Call: suivre ${callAmount}` : '✗ Call: rien à suivre';
            document.getElementById('rule4').textContent = '✓ Raise: toujours possible';

            document.getElementById('rule2').className = callAmount > 0 ? 'text-red-400' : 'text-green-400';
            document.getElementById('rule3').className = callAmount > 0 ? 'text-green-400' : 'text-red-400';
        }

        function performAction(action) {
            const currentPlayerData = gameState.players[gameState.currentPlayer - 1];
            const callAmount = gameState.currentBet - currentPlayerData.currentBet;
            let valid = true;
            let message = '';

            switch (action) {
                case 'fold':
                    logAction(currentPlayerData.name, 'fold', null, true);
                    break;

                case 'check':
                    if (callAmount > 0) {
                        valid = false;
                        message = `❌ ERREUR: ${currentPlayerData.name} ne peut pas checker car il y a une mise de ${callAmount} à suivre !`;
                    } else {
                        logAction(currentPlayerData.name, 'check', null, true);
                    }
                    break;

                case 'call':
                    if (callAmount === 0) {
                        valid = false;
                        message = `❌ ERREUR: ${currentPlayerData.name} ne peut pas call car il n'y a rien à suivre !`;
                    } else {
                        currentPlayerData.chips -= callAmount;
                        currentPlayerData.currentBet += callAmount;
                        logAction(currentPlayerData.name, 'call', callAmount, true);
                    }
                    break;
            }

            if (!valid) {
                showValidationMessage(message, false);
                return;
            }

            nextPlayer();
        }

        function showRaiseInput() {
            document.getElementById('raiseInput').classList.remove('hidden');
        }

        function hideRaiseInput() {
            document.getElementById('raiseInput').classList.add('hidden');
        }

        function performRaise() {
            const amount = parseInt(document.getElementById('raiseAmount').value);
            const currentPlayerData = gameState.players[gameState.currentPlayer - 1];

            if (amount <= gameState.currentBet) {
                showValidationMessage('❌ Le raise doit être supérieur à la mise actuelle', false);
                return;
            }

            const totalBet = amount;
            const additionalBet = totalBet - currentPlayerData.currentBet;

            if (additionalBet > currentPlayerData.chips) {
                showValidationMessage('❌ Pas assez de jetons', false);
                return;
            }

            currentPlayerData.chips -= additionalBet;
            currentPlayerData.currentBet = totalBet;
            gameState.currentBet = totalBet;
            gameState.lastRaiser = currentPlayerData.name;

            logAction(currentPlayerData.name, 'raise', totalBet, true);
            hideRaiseInput();
            nextPlayer();
        }

        function nextPlayer() {
            gameState.currentPlayer = (gameState.currentPlayer % 4) + 1;
            updateDisplay();
        }

        function logAction(player, action, amount, valid) {
            const log = document.getElementById('actionLog');
            const entry = document.createElement('div');
            entry.className = `text-sm p-2 rounded ${valid ? 'bg-green-900/30 border-l-4 border-green-500' : 'bg-red-900/30 border-l-4 border-red-500'}`;
            
            const actionText = amount ? `${action} (${amount})` : action;
            const timeStamp = new Date().toLocaleTimeString('fr-FR');
            
            entry.innerHTML = `
                <div class="flex justify-between">
                    <span class="${valid ? 'text-green-400' : 'text-red-400'}">${player} ${actionText}</span>
                    <span class="text-gray-500 text-xs">${timeStamp}</span>
                </div>
            `;
            
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 10 entries
            while (log.children.length > 10) {
                log.removeChild(log.lastChild);
            }
        }

        function showValidationMessage(message, isSuccess) {
            const msgDiv = document.getElementById('validationMsg');
            msgDiv.className = `mt-4 p-3 rounded-lg ${isSuccess ? 'bg-green-900/30 border border-green-500 text-green-400' : 'bg-red-900/30 border border-red-500 text-red-400'}`;
            msgDiv.textContent = message;
            msgDiv.classList.remove('hidden');
            
            setTimeout(() => {
                msgDiv.classList.add('hidden');
            }, 3000);
        }

        function resetRound() {
            gameState = {
                currentBet: 0,
                lastRaiser: null,
                currentPlayer: 1,
                players: [
                    { id: 1, name: 'Joueur 1', chips: 1000, currentBet: 0 },
                    { id: 2, name: 'Joueur 2', chips: 1000, currentBet: 0 },
                    { id: 3, name: 'Joueur 3', chips: 1000, currentBet: 0 },
                    { id: 4, name: 'Joueur 4', chips: 1000, currentBet: 0 }
                ]
            };
            document.getElementById('actionLog').innerHTML = '';
            updateDisplay();
            logAction('Système', 'Nouveau tour de mise', null, true);
        }

        // Test scenarios
        function testScenario1() {
            resetRound();
            setTimeout(() => {
                // Joueur 1 raise
                gameState.players[0].chips -= 200;
                gameState.players[0].currentBet = 200;
                gameState.currentBet = 200;
                gameState.lastRaiser = 'Joueur 1';
                gameState.currentPlayer = 2;
                logAction('Joueur 1', 'raise', 200, true);
                updateDisplay();
                
                showValidationMessage('🧪 Test: Joueur 1 a fait raise. Joueur 2 peut-il checker? (NON!)', true);
            }, 500);
        }

        function testScenario2() {
            resetRound();
            setTimeout(() => {
                // Joueur 1 check
                gameState.currentPlayer = 2;
                logAction('Joueur 1', 'check', null, true);
                updateDisplay();
                
                showValidationMessage('🧪 Test: Joueur 1 a check. Joueur 2 peut checker ou raise', true);
            }, 500);
        }

        function testScenario3() {
            resetRound();
            setTimeout(() => {
                // Joueur 1 raise
                gameState.players[0].chips -= 200;
                gameState.players[0].currentBet = 200;
                gameState.currentBet = 200;
                gameState.lastRaiser = 'Joueur 1';
                gameState.currentPlayer = 2;
                logAction('Joueur 1', 'raise', 200, true);
                updateDisplay();
                
                setTimeout(() => {
                    // Joueur 2 call
                    gameState.players[1].chips -= 200;
                    gameState.players[1].currentBet = 200;
                    gameState.currentPlayer = 3;
                    logAction('Joueur 2', 'call', 200, true);
                    updateDisplay();
                    
                    showValidationMessage('✅ Correct: Après raise, le joueur a fait call', true);
                }, 1000);
            }, 500);
        }

        // Initialize
        updateDisplay();
        logAction('Système', 'Interface de test initialisée', null, true);
    </script>
</body>
</html>